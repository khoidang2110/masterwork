deploy-to-vps2:
  stage: deploy
  only:
    - main
  tags:
    - gitlabvps2
  script:
    - echo "ğŸ” Cáº¥u hÃ¬nh SSH"
    - apt-get update -y && apt-get install -y openssh-client
    - eval $(ssh-agent -s)
    - echo "$gitlabvps2" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p 22 14.225.220.181 >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

    - echo "ğŸš€ Triá»ƒn khai á»©ng dá»¥ng..."
    - ssh -o StrictHostKeyChecking=no root@14.225.220.181 "
        echo 'ğŸ“ Kiá»ƒm tra folder project' &&
        if [ ! -d /home/root/masterworkgitlab ]; then
          echo 'ğŸ“¥ ChÆ°a cÃ³ project => clone' &&
          git clone http://john2110.ddns.net:8003/john/masterworkgitlab /home/root/masterworkgitlab;
        fi &&

        echo 'ğŸ“‚ Di chuyá»ƒn vÃ o project' &&
        cd /home/root/masterworkgitlab &&

        echo 'ğŸ”€ Checkout main vÃ  thiáº¿t láº­p tracking (náº¿u cáº§n)' &&
        git checkout main || git checkout -b main origin/main &&
        git branch --set-upstream-to=origin/main main &&

        echo 'ğŸ”„ Pull cáº­p nháº­t' &&
        git reset --hard &&
        git pull &&

        echo 'ğŸ›‘ Dá»«ng container cÅ© (náº¿u cÃ³)' &&
        docker-compose down || echo '[WARNING] KhÃ´ng cÃ³ container cÅ©' &&

        echo 'ğŸ”„ Build vÃ  khá»Ÿi Ä‘á»™ng láº¡i container' &&
        docker-compose up -d --build &&

        echo 'ğŸ§¹ Dá»n dáº¹p image khÃ´ng dÃ¹ng' &&
        docker image prune -f &&

        echo 'âœ… Deploy thÃ nh cÃ´ng!'
      "
